<?php/*
 * AlcedisMED
 * Copyright (C) 2010-2016  Alcedis GmbH
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */ 

    $fields     = array();    $queryParts = array();    $sub    = isset($_REQUEST['sub'])  ? str_replace("'", "", stripslashes($_REQUEST['sub'])) : '';    $name   = isset($_REQUEST['name']) ? str_replace("'", "", stripslashes($_REQUEST['name'])): '';    $type   = isset($_REQUEST['type']) ? str_replace("'", "", stripslashes($_REQUEST['type'])): '';    $tables = array('histologie');    $eJoin  = $sub !== 'oz' ? "AND e.erkrankung = '{$sub}'" : null;    switch ($name) {      case 'oz02_2':      case 'oz02_1':          //Bei oz02 muessen fuer darm auch theoretische Eingriffe im Dropdown angezeigt werden          $queryParts[] = "             SELECT                  DISTINCT YEAR(t.datum) AS code,                  YEAR(t.datum) AS bez             FROM patient p                  INNER JOIN erkrankung e ON p.patient_id = e.patient_id AND e.erkrankung = 'd'                  INNER JOIN eingriff t ON t.erkrankung_id = e.erkrankung_id             WHERE                 p.org_id = '{$org_id}'             GROUP BY                 code         ";          // auf zytologie bei erkrankung leu, ly, snst schauen          $queryParts[] = "              SELECT                  DISTINCT YEAR(z.datum) AS code,                  YEAR(z.datum) AS bez              FROM patient p                  INNER JOIN erkrankung e ON p.patient_id = e.patient_id AND e.erkrankung IN ('leu', 'ly', 'snst')                  INNER JOIN zytologie z ON z.erkrankung_id = e.erkrankung_id              WHERE                  p.org_id = '{$org_id}'              GROUP BY                  code          ";          break;      case 'b05':          $queryNachsorgeJahre = "              SELECT DISTINCT                  DATE_FORMAT(n.datum, '%Y') AS code,                  DATE_FORMAT(n.datum, '%Y') AS bez              FROM                  patient p                  INNER JOIN erkrankung e ON e.patient_id=p.patient_id                                             AND e.erkrankung='b'                  INNER JOIN nachsorge n  ON n.patient_id=e.patient_id              WHERE                  p.org_id={$org_id}                  AND DATE_FORMAT(n.datum, '%Y') <= (DATE_FORMAT(NOW(), '%Y'))              ORDER BY                  n.datum DESC          ";          $fields['nachsorgeJahr'] = array('req' => 0, 'size' => '', 'maxlen' => '', 'type' => 'query',  'ext' => $queryNachsorgeJahre, 'emptyField' => false);          $fields['rohdatenx'] = array('req' => 0, 'size' => '', 'maxlen' => '', 'type' => 'lookup', 'ext' => array('l_basic' => 'rpt_b05_rohdaten'), 'emptyField' => true);          break;        case 'b07':            $fields['rohdatenx'] = array('req' => 0, 'size' => '', 'maxlen' => '', 'type' => 'lookup', 'ext' => array('l_basic' => 'rpt_b05_rohdaten'), 'emptyField' => true);            break;        case 'kh05':            $queryNachsorgeJahre = "              SELECT DISTINCT                  DATE_FORMAT(n.datum, '%Y') AS code,                  DATE_FORMAT(n.datum, '%Y') AS bez              FROM                  patient p                  INNER JOIN erkrankung e ON e.patient_id=p.patient_id                                             AND e.erkrankung='kh'                  INNER JOIN nachsorge n  ON n.patient_id=e.patient_id              WHERE                  p.org_id={$org_id}                  AND DATE_FORMAT(n.datum, '%Y') <= (DATE_FORMAT(NOW(), '%Y'))              ORDER BY                  n.datum DESC            ";            $fields['nachsorgeJahr'] = array('req' => 0, 'size' => '', 'maxlen' => '', 'type' => 'query',  'ext' => $queryNachsorgeJahre, 'emptyField' => false);            break;        case 'd02':          $tables[] = 'eingriff';          break;      case 'p01':      case 'p02':      case 'p04':      case 'p04_1':      case 'p03':      case 'p05_1':      case 'p06':      case 'p07':         $fields['datumsbezug'] = array('req' => 0, 'size' => '', 'maxlen' => '', 'type' => 'lookup', 'ext' => array('l_basic' => 'rpt_pz01_bezug'), 'emptyField' => false);         if ($name == 'p06') {             $fields['kennzahlenjahr'] = array('req' => 0, 'size' => '', 'maxlen' => '', 'type' => 'lookup', 'ext' => array('l_basic' => 'rpt_pz06_bezug'), 'emptyField' => false);         }         break;      case 'p05_2':         $tables[] = 'eingriff';         $fields['datumsbezug'] = array('req' => 0, 'size' => '', 'maxlen' => '', 'type' => 'lookup', 'ext' => array('l_basic' => 'rpt_pz05_2_bezug'), 'emptyField' => false);         $queryParts[] = "             SELECT                 DISTINCT YEAR(n.datum) AS code,                 YEAR(n.datum) AS bez             FROM patient p                 INNER JOIN erkrankung e ON p.patient_id = e.patient_id {$eJoin}                 INNER JOIN nachsorge_erkrankung ne ON ne.erkrankung_weitere_id = e.erkrankung_id                 INNER JOIN nachsorge n ON ne.nachsorge_id = n.nachsorge_id             WHERE                 p.org_id = '{$org_id}'             GROUP BY                 code         ";         break;        case 'h01_2':            $fields['datumsbezug'] = array('req' => 0, 'size' => '', 'maxlen' => '', 'type' => 'lookup', 'ext' => array('l_basic' => 'rpt_hz01_2_bezug'), 'emptyField' => false);            break;   }   foreach ($tables as $table) {      $queryParts[] = "          SELECT              DISTINCT YEAR(t.datum) AS code,              YEAR(t.datum) AS bez          FROM patient p              INNER JOIN erkrankung e ON p.patient_id = e.patient_id {$eJoin}              INNER JOIN {$table} t ON t.erkrankung_id = e.erkrankung_id          WHERE              p.org_id = '{$org_id}'          GROUP BY              code      ";   }   $query = implode(' UNION ', $queryParts) . ' ORDER BY bez DESC';   // TODO die generierung der einzelnen abfragen besser auslagern   // das hier ist nur ein workaround   if ($name == 'p01_2') {       $query = "SELECT DISTINCT YEAR(datum) AS 'code', YEAR(datum) AS 'bez' FROM `konferenz` ORDER BY bez DESC";   }   $fields = array_merge(      $fields,      array(        'roh_daten'   => array('req' => 0, 'size' => '', 'maxlen' => '', 'type' => 'check',  'ext' => ''),        'datum_von'   => array('req' => 0, 'size' => '', 'maxlen' => '', 'type' => 'date',   'ext' => ''),        'datum_bis'   => array('req' => 0, 'size' => '', 'maxlen' => '', 'type' => 'date',   'ext' => ''),        'jahr'        => array('req' => 0, 'size' => '', 'maxlen' => '', 'type' => 'query',  'ext' => $query, 'emptyField' => false )      )   );?>