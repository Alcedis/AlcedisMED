<?php/*
 * AlcedisMED
 * Copyright (C) 2010-2016  Alcedis GmbH
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */ 

class reportContentLu03 extends reportExtensionLu{   protected $_values = array();   public function init(alcReportPdf $renderer){      $renderer->addPage();   }   protected $_initArray = array();   protected function _initValues()   {      $this->_initPercentArray($this->_initArray = array(         'ct'        => array('val' => explode('|', 'alle|cT0|cTis|cT1|cT1a|cT1b|cT2|cT2a|cT2b|cT3|cT4|cTX|keine_angabe')),         'cn'        => array('val' => explode('|', 'alle|cN0|cN1|cN2|cN3|cNX|keine_angabe')),         'pt'        => array('val' => explode('|', 'alle|pT0|pTis|pT1|pT1a|pT1b|pT2|pT2a|pT2b|pT3|pT4|pTX|keine_angabe')),         'pn'        => array('val' => explode('|', 'alle|pN0|pN1|pN2|pN3|pNX|keine_angabe')),         'm'         => array('val' => explode('|', 'alle|M0|M1|M1a|M1b|MX|keine_angabe')),         'g'         => array('val' => explode('|', 'alle|G1|G2|G3|G4|GX|keine_angabe')),         'uicc'      => array('val' => explode('|', 'alle|0|0a|0is|I|IA|IA1|IA2|IB|IB1|IB2|IC|II|IIA|IIA1|IIA2|IIB|IIC|III|IIIA|IIIA1|IIIA2|IIIA3|IIIA4|IIIB|IIIC|IIIC1|IIIC2|IV|IVA|IVB|IVC|okkult|keine_angabe')),         'operateure' => array(            'val'                => array(),            'operateure_lymph'   => array(),            'operateure_pneumo'  => array(),            'operateure_broncho' => array(),         ),         'invasiv'            => array('val' => array('alle', 'invasiv_tn')),         'resektion'          => array('val' => array('alle', 'resektion_stadium', 'resektion_abstand')),         'radio' => array(            'val'           => array(),            'radio_alle'    => array(),            'radio_primaer' => array()         ),         'chemoimmun'         => array('val' => array()),         'chemoimmun_lunge'   => array('val' => array()),         'schnellschnitt' => array(            'val'    => array('alle_schnell', 'gr30', 'kl30'),            'min'    => array('alle_schnell' => '-', 'gr30' => '-', 'kl30' => '-'),            'max'    => array('alle_schnell' => '-', 'gr30' => '-', 'kl30' => '-'),            'range'  => array('alle_schnell' => '-', 'gr30' => '-', 'kl30' => '-')         ),      ));   }   public function generate($renderer)   {      $renderer->setConfig($this->loadConfigs('lu03', false, true));      $additionalContentLu011 = array(         'fields' => array(            "sit.morphologie AS 'morphologie'",             "GROUP_CONCAT(DISTINCT IF(op.schnellschnitt = '1', op.eingriff_id, NULL)) AS 'schnellschnitt_alle_schnell'",             "MIN(IF(op.schnellschnitt = 1, op.schnellschnitt_dauer, NULL))     AS 'schnellschnitt_min'",             "MAX(IF(op.schnellschnitt = 1, op.schnellschnitt_dauer, NULL))     AS 'schnellschnitt_max'",             "GROUP_CONCAT(DISTINCT IF(op.schnellschnitt = 1 AND (op.schnellschnitt_dauer IS NOT NULL AND op.schnellschnitt_dauer > 30), op.eingriff_id, NULL))   AS 'schnellschnitt_gr30'",             "MIN(IF(op.schnellschnitt = 1 AND (op.schnellschnitt_dauer IS NOT NULL AND op.schnellschnitt_dauer > 30), op.schnellschnitt_dauer, NULL)) AS 'schnellschnitt_gr30_min'",             "MAX(IF(op.schnellschnitt = 1 AND (op.schnellschnitt_dauer IS NOT NULL AND op.schnellschnitt_dauer > 30), op.schnellschnitt_dauer, NULL)) AS 'schnellschnitt_gr30_max'",             "GROUP_CONCAT(DISTINCT IF(op.schnellschnitt = 1 AND (op.schnellschnitt_dauer IS NOT NULL AND op.schnellschnitt_dauer <= 30), op.eingriff_id, NULL))   AS 'schnellschnitt_kl30'",             "MIN(IF(op.schnellschnitt = 1 AND (op.schnellschnitt_dauer IS NOT NULL AND op.schnellschnitt_dauer <= 30), op.schnellschnitt_dauer, NULL)) AS 'schnellschnitt_kl30_min'",             "MAX(IF(op.schnellschnitt = 1 AND (op.schnellschnitt_dauer IS NOT NULL AND op.schnellschnitt_dauer <= 30), op.schnellschnitt_dauer, NULL)) AS 'schnellschnitt_kl30_max'"         )      );      $additionalContentLu012 = array(         'fields' => array(            "op.operateur1_id AS 'operateur1'"         )      );      $data['lu01_1'] = $this->loadRessource('lu01_1', $additionalContentLu011);      $data['lu01_2'] = $this->loadRessource('lu01_2', $additionalContentLu012);      $this->_initValues();      $schnellschnitte = array(          'alle_schnell'  => array(),          'gr30' => array(),          'kl30' => array()      );      foreach ($data['lu01_1'] as $dataset) {         foreach (array('p', 'c') as $st) {             $this->_values[$st . 't']['count']++;             $this->_values[$st . 't']['val']['alle']++;             $this->_values[$st . 't']['val'][$st . 'T0']   += (int) ($dataset[$st . 't'] == $st . 'T0');             $this->_values[$st . 't']['val'][$st . 'Tis']  += (int) ($dataset[$st . 't'] == $st . 'Tis');             $this->_values[$st . 't']['val'][$st . 'T1']   += (int) ($dataset[$st . 't'] == $st . 'T1');             $this->_values[$st . 't']['val'][$st . 'T1a']  += (int) ($dataset[$st . 't'] == $st . 'T1a');             $this->_values[$st . 't']['val'][$st . 'T1b']  += (int) ($dataset[$st . 't'] == $st . 'T1b');             $this->_values[$st . 't']['val'][$st . 'T2']   += (int) ($dataset[$st . 't'] == $st . 'T2');             $this->_values[$st . 't']['val'][$st . 'T2a']  += (int) ($dataset[$st . 't'] == $st . 'T2a');             $this->_values[$st . 't']['val'][$st . 'T2b']  += (int) ($dataset[$st . 't'] == $st . 'T2b');             $this->_values[$st . 't']['val'][$st . 'T3']   += (int) ($dataset[$st . 't'] == $st . 'T3');             $this->_values[$st . 't']['val'][$st . 'T4']   += (int) ($dataset[$st . 't'] == $st . 'T4');             $this->_values[$st . 't']['val'][$st . 'TX']   += (int) ($dataset[$st . 't'] == $st . 'TX');             $this->_values[$st . 't']['val']['keine_angabe'] += (int) (strlen($dataset[$st . 't']) == 0);             $this->_values[$st . 'n']['count']++;             $this->_values[$st . 'n']['val']['alle']++;             $this->_values[$st . 'n']['val'][$st . 'N0']  += (int) ($dataset[$st . 'n'] == $st . 'N0');             $this->_values[$st . 'n']['val'][$st . 'N1']  += (int) ($dataset[$st . 'n'] == $st . 'N1');             $this->_values[$st . 'n']['val'][$st . 'N2']  += (int) ($dataset[$st . 'n'] == $st . 'N2');             $this->_values[$st . 'n']['val'][$st . 'N3']  += (int) ($dataset[$st . 'n'] == $st . 'N3');             $this->_values[$st . 'n']['val'][$st . 'NX']  += (int) ($dataset[$st . 'n'] == $st . 'NX');             $this->_values[$st . 'n']['val']['keine_angabe'] += (int) (strlen($dataset[$st . 'n']) == 0);         }         //m         $this->_values['m']['count']++;         $this->_values['m']['val']['alle']++;         $this->_values['m']['val']['M0']           += (int) (substr($dataset['m'], 1) == 'M0');         $this->_values['m']['val']['M1']           += (int) (substr($dataset['m'], 1) == 'M1');         $this->_values['m']['val']['M1a']          += (int) (substr($dataset['m'], 1) == 'M1a');         $this->_values['m']['val']['M1b']          += (int) (substr($dataset['m'], 1) == 'M1b');         $this->_values['m']['val']['MX']           += (int) (substr($dataset['m'], 1) == 'MX');         $this->_values['m']['val']['keine_angabe'] += (int) (strlen($dataset['m']) == 0);         //g         $this->_values['g']['count']++;         $this->_values['g']['val']['alle']++;         $this->_values['g']['val']['GX']           += (int) ($dataset['g'] == 'X');         $this->_values['g']['val']['G1']           += (int) ($dataset['g'] == '1');         $this->_values['g']['val']['G2']           += (int) ($dataset['g'] == '2');         $this->_values['g']['val']['G3']           += (int) ($dataset['g'] == '3');         $this->_values['g']['val']['G4']           += (int) ($dataset['g'] == '4');         $this->_values['g']['val']['keine_angabe'] += (int) (strlen($dataset['g']) == 0);         //uicc         $this->_values['uicc']['count']++;         $this->_values['uicc']['val']['alle']++;         $this->_values['uicc']['val']['0']      +=  (int) ($dataset['uicc'] == '0');         $this->_values['uicc']['val']['0a']     +=  (int) ($dataset['uicc'] == '0a');         $this->_values['uicc']['val']['0is']    +=  (int) ($dataset['uicc'] == '0is');         $this->_values['uicc']['val']['I']      +=  (int) ($dataset['uicc'] == 'I');         $this->_values['uicc']['val']['IA']     +=  (int) ($dataset['uicc'] == 'IA');         $this->_values['uicc']['val']['IA1']    +=  (int) ($dataset['uicc'] == 'IA1');         $this->_values['uicc']['val']['IA2']    +=  (int) ($dataset['uicc'] == 'IA2');         $this->_values['uicc']['val']['IB']     +=  (int) ($dataset['uicc'] == 'IB');         $this->_values['uicc']['val']['IB1']    +=  (int) ($dataset['uicc'] == 'IB1');         $this->_values['uicc']['val']['IB2']    +=  (int) ($dataset['uicc'] == 'IB2');         $this->_values['uicc']['val']['IC']     +=  (int) ($dataset['uicc'] == 'IC');         $this->_values['uicc']['val']['II']     +=  (int) ($dataset['uicc'] == 'II');         $this->_values['uicc']['val']['IIA']    +=  (int) ($dataset['uicc'] == 'IIA');         $this->_values['uicc']['val']['IIA1']   +=  (int) ($dataset['uicc'] == 'IIA1');         $this->_values['uicc']['val']['IIA2']   +=  (int) ($dataset['uicc'] == 'IIA2');         $this->_values['uicc']['val']['IIB']    +=  (int) ($dataset['uicc'] == 'IIB');         $this->_values['uicc']['val']['IIC']    +=  (int) ($dataset['uicc'] == 'IIC');         $this->_values['uicc']['val']['III']    +=  (int) ($dataset['uicc'] == 'III');         $this->_values['uicc']['val']['IIIA']   +=  (int) ($dataset['uicc'] == 'IIIA');         $this->_values['uicc']['val']['IIIA1']  +=  (int) ($dataset['uicc'] == 'IIIA1');         $this->_values['uicc']['val']['IIIA2']  +=  (int) ($dataset['uicc'] == 'IIIA2');         $this->_values['uicc']['val']['IIIA3']  +=  (int) ($dataset['uicc'] == 'IIIA3');         $this->_values['uicc']['val']['IIIA4']  +=  (int) ($dataset['uicc'] == 'IIIA4');         $this->_values['uicc']['val']['IIIB']   +=  (int) ($dataset['uicc'] == 'IIIB');         $this->_values['uicc']['val']['IIIC']   +=  (int) ($dataset['uicc'] == 'IIIC');         $this->_values['uicc']['val']['IIIC1']  +=  (int) ($dataset['uicc'] == 'IIIC1');         $this->_values['uicc']['val']['IIIC2']  +=  (int) ($dataset['uicc'] == 'IIIC2');         $this->_values['uicc']['val']['IV']     +=  (int) ($dataset['uicc'] == 'IV');         $this->_values['uicc']['val']['IVA']    +=  (int) ($dataset['uicc'] == 'IVA');         $this->_values['uicc']['val']['IVB']    +=  (int) ($dataset['uicc'] == 'IVB');         $this->_values['uicc']['val']['IVC']    +=  (int) ($dataset['uicc'] == 'IVC');         $this->_values['uicc']['val']['okkult'] +=  (int) ($dataset['uicc'] == 'Okkultes Karzinom');         $this->_values['uicc']['val']['keine_angabe'] += (int) (strlen($dataset['uicc']) == 0);         //lu03.9 Angabe pT, pN bei invasivem Karzinom         if (strpos($dataset['morphologie'], '/3') !== false) {             $this->_values['invasiv']['count']++;             $this->_values['invasiv']['val']['alle']++;             $this->_values['invasiv']['val']['invasiv_tn'] += (int) (strlen($dataset['pt']) > 0 && strlen($dataset['pn']) > 0);         }         //lu03.10 Resektions-/Sicherheitsabstand         if (strlen($dataset['ops_codes']) > 0 && strpos($dataset['ops_codes'], '5-') !== false) {            $this->_values['resektion']['count']++;            $this->_values['resektion']['val']['alle']++;            $this->_values['resektion']['val']['resektion_stadium'] += (int) (strlen($dataset['r_lokal']) > 0);            $this->_values['resektion']['val']['resektion_abstand'] += (int) (strlen($dataset['sicherheitsabstand']) > 0);         }         //lu03.13 Schnellschnitte         if ($dataset['intraop_schnellschnitt'] == 1) {            foreach ($schnellschnitte as $sec => $c) {                if (strlen($dataset["schnellschnitt_{$sec}"]) > 0) {                    foreach (explode(',', $dataset["schnellschnitt_{$sec}"]) as $eId) {                        $schnellschnitte[$sec][$eId] = 1;                    }                }            }            // all            $this->_values['schnellschnitt']['min']['alle_schnell']     = $this->_insert('min', $this->_values['schnellschnitt']['min']['alle_schnell'], $dataset['schnellschnitt_min']);            $this->_values['schnellschnitt']['max']['alle_schnell']     = $this->_insert('max', $this->_values['schnellschnitt']['max']['alle_schnell'], $dataset['schnellschnitt_max']);            $this->_values['schnellschnitt']['range']['alle_schnell']   = $this->_insert('range', $this->_values['schnellschnitt']['max']['alle_schnell'], $this->_values['schnellschnitt']['min']['alle_schnell']);            // greater then 30 min            $this->_values['schnellschnitt']['min']['gr30']     = $this->_insert('min', $this->_values['schnellschnitt']['min']['gr30'], $dataset['schnellschnitt_gr30_min']);            $this->_values['schnellschnitt']['max']['gr30']     = $this->_insert('max', $this->_values['schnellschnitt']['max']['gr30'], $dataset['schnellschnitt_gr30_max']);            $this->_values['schnellschnitt']['range']['gr30']   = $this->_insert('range', $this->_values['schnellschnitt']['max']['gr30'], $this->_values['schnellschnitt']['min']['gr30']);            // lesser then 30 min            $this->_values['schnellschnitt']['min']['kl30']     = $this->_insert('min', $this->_values['schnellschnitt']['min']['kl30'], $dataset['schnellschnitt_kl30_min']);            $this->_values['schnellschnitt']['max']['kl30']     = $this->_insert('max', $this->_values['schnellschnitt']['max']['kl30'], $dataset['schnellschnitt_kl30_max']);            $this->_values['schnellschnitt']['range']['kl30']   = $this->_insert('range', $this->_values['schnellschnitt']['max']['kl30'], $this->_values['schnellschnitt']['min']['kl30']);          }       }       //Schnellschnitte       $this->_values['schnellschnitt']['count'] = (int) count($schnellschnitte['alle_schnell']);       foreach ($schnellschnitte as $sec => $c) {           $this->_values['schnellschnitt']['val'][$sec]  = (int) count($schnellschnitte[$sec]);       }       //lu03.8 Thoraxchirurgische Eingriffe pro Operateur       $operateurData = array();       foreach ($data['lu01_2'] AS $dataset) {          $eingriffId  = $dataset['eingriff_id'];          //lu03.8 Thoraxchirurgische Eingriffe pro Operateur          $operateurId = $dataset['operateur1'];          if (strlen($operateurId) > 0) {            if (isset($operateurData[$operateurId]) === false) {              $operateurData[$operateurId] = $this->_buildOpArray();            }            $operateurData[$operateurId]['operateure_lymph'][$eingriffId]     = (int) ($dataset['lungenresektion'] == '1');            $operateurData[$operateurId]['operateure_pneumo'][$eingriffId]    = (int) ($dataset['pneumektomie'] == '1');            $operateurData[$operateurId]['operateure_broncho'][$eingriffId]   = (int) ($dataset['broncho_op'] == '1');          }       }       //lu03.11 Radiotherapie       $data['radiotherapie'] = $this->loadRessource('strahlentherapien');       foreach ($data['radiotherapie'] AS $orgId => $counts) {          $this->_values['radio']['val'][$orgId] = 1;          $this->_values['radio']['radio_alle'][] = $counts['all'];          $this->_values['radio']['radio_primaer'][] = $counts['primaerfall'];       }       //lu03.12 Anzahl durchgeführte Chemo-/Immuntherapien       $data['chemoimmun'] = $this->loadRessource('chemoImmuntherapien');       foreach ($data['chemoimmun']['all'] AS $orgId => $chemoCount) {          $this->_values['chemoimmun']['val'][$orgId] = $chemoCount;       }       foreach ($data['chemoimmun']['disease'] AS $orgId => $chemoCount) {          $this->_values['chemoimmun_lunge']['val'][$orgId] = $chemoCount;       }      //Zuweisung Operateure      foreach ($operateurData as $arzt => $op) {         $this->_values['operateure']['val'][$arzt]           = 1;         $this->_values['operateure']['operateure_lymph'][]   = array_sum($op['operateure_lymph']);         $this->_values['operateure']['operateure_pneumo'][]  = array_sum($op['operateure_pneumo']);         $this->_values['operateure']['operateure_broncho'][] = array_sum($op['operateure_broncho']);      }       require_once 'reports/pdf/lu/lu03/p1.php';   }   private function _buildOpArray()   {      return array(         'val'                => array(),         'operateure_lymph'   => array(),         'operateure_pneumo'  => array(),         'operateure_broncho' => array(),      );   }   private function _insert($type, $src, $value, $default = '-')   {      $val = $src !== $default ? $src : $default;      switch ($type) {         case 'range':            if (is_int($src) == true && is_int($value) == true) {               $val = $src - $value;            }            break;         case 'max':         case 'min':            if (strlen($value) > 0) {               $value   = (int) $value;               $src     = $src !== $default ? $src : (                  $type == 'min' ? $value : 0               );               eval('$compare = $type == "max" ? ($value >= $src) : ($value <= $src);');               if ($compare == true) {                  $val = $value;               }            } else {               $val = $src;            }            break;      }      return $val;   }}?>