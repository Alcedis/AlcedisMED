<?php/*
 * AlcedisMED
 * Copyright (C) 2010-2016  Alcedis GmbH
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */ 

class reportContentD03 extends reportExtensionD{   protected $_values = array();   public function init(alcReportPdf $renderer){      $renderer->addPage();   }   private function _initValues()   {      $percentArray = array(         'dignitaet'      => array('val' => array('alle', 'in_situ', 'maligne', 'sonstige', 'keine_angabe')),         'pt'             => array('val' => array('alle', 'pT0', 'pTis', 'pT1', 'pT2', 'pT3', 'pT4', 'pT4a', 'pT4b', 'pTX', 'keine_angabe', 'keine_op')),         'pn'             => array('val' => array('alle', 'pN0', 'pN1', 'pN1a', 'pN1b', 'pN1c', 'pN2', 'pN2a', 'pN2b', 'pNX', 'keine_angabe', 'keine_op')),         'm'              => array('val' => array('alle', 'M0', 'M1', 'M1a', 'M1b', 'MX', 'keine_angabe')),         'g'              => array('val' => array('alle', 'gX', 'g1', 'g2', 'g3', 'g4', 'keine_angabe')),         'uicc'           => array('val' => array('alle', 'uicc_0', 'uicc_I', 'uicc_IIA', 'uicc_IIB', 'uicc_IIC', 'uicc_III', 'uicc_IIIA', 'uicc_IIIB', 'uicc_IIIC', 'uicc_IV', 'keine_angabe')),         'krthk'          => array('val', 'thkol'),         'krdiagk'        => array('val', 'diagkol'),         'lymph'          => array('val' => array('alle_op', 'lkue12', 'lkk12')),         'nw_str'         => array('val' => array()),         'nw_chemo'       => array('val' => array()),         'nw_ah'          => array('val' => array()),         'nw_i'           => array('val' => array()),         'nw_st'          => array('val' => array()),         'nw_str_che'     => array('val' => array()),         'schnellschnitt' => array(            'val'    => array('alle_schnell', 'gr30', 'kl30'),            'min'    => array('alle_schnell' => '-', 'gr30' => '-', 'kl30' => '-'),            'max'    => array('alle_schnell' => '-', 'gr30' => '-', 'kl30' => '-'),            'range'  => array('alle_schnell' => '-', 'gr30' => '-', 'kl30' => '-')         ),         'biopsate' => array(            'val'    => array('alle_biopsate', 'gr3', 'kl3'),            'min'    => array('alle_biopsate' => '-', 'gr3' => '-', 'kl3' => '-'),            'max'    => array('alle_biopsate' => '-', 'gr3' => '-', 'kl3' => '-'),            'range'  => array('alle_biopsate' => '-', 'gr3' => '-', 'kl3' => '-')         ),         'praeparate' => array(            'val'    => array('alle_praeparate', 'gr5', 'kl5'),            'min'    => array('alle_praeparate' => '-', 'gr5' => '-', 'kl5' => '-'),            'max'    => array('alle_praeparate' => '-', 'gr5' => '-', 'kl5' => '-'),            'range'  => array('alle_praeparate' => '-', 'gr5' => '-', 'kl5' => '-')         ),         'operateure' => array(            'val'                => array(),            'op_colon_gesamt'    => array(),            'op_colon_operateur' => array(),            'op_colon_assi'      => array(),            'op_rektum_gesamt'   => array(),            'op_rektum_operateur'=> array(),            'op_rektum_assi'     => array()         ),         'praeop_dignitaet' => array('val' => array('alle_op_prim', 'praeop_abgeklaert')),         'chemo_d' => array('val' => array()),         'chemo_d_indikation' => array('val' => array())      );      $this         ->_initPercentArray($percentArray)      ;      return $this;   }   public function generate($renderer)   {      $renderer->setConfig($this->loadConfigs('d03', false, true));      $this->_filterDisease();      $dataCache  = array();      $koloskopieUntersuchungClause = $this->_buildKoloskopieClause('u.art');      $additionalContent = array();      $additionalContent['selects'] = array(          "(SELECT IF(ts.lk_entf < 12, 1, 0) FROM tumorstatus ts WHERE ts.erkrankung_id = t.erkrankung_id AND ts.anlass = t.anlass AND ts.lk_entf IS NOT NULL     ORDER BY ts.datum_sicherung DESC, ts.sicherungsgrad ASC, ts.datum_beurteilung DESC LIMIT 1) AS lkk12",          "(SELECT IF(ts.lk_entf >= 12, 1, 0) FROM tumorstatus ts WHERE ts.erkrankung_id = t.erkrankung_id AND ts.anlass = t.anlass AND ts.lk_entf IS NOT NULL    ORDER BY ts.datum_sicherung DESC, ts.sicherungsgrad ASC, ts.datum_beurteilung DESC LIMIT 1) AS lkue12",      );      //simultane radio chemotherapien      $query = "         SELECT            1 as 'grp',            GROUP_CONCAT(DISTINCT x.vorlage_therapie_id) AS 'vorlage_therapie_ids'         FROM (            SELECT               vt.vorlage_therapie_id            FROM vorlage_therapie vt               INNER JOIN vorlage_therapie_wirkstoff vt_wirk_str    ON vt_wirk_str.vorlage_therapie_id = vt.vorlage_therapie_id AND vt_wirk_str.art = 'str'               INNER JOIN vorlage_therapie_wirkstoff vt_wirk_ch     ON vt_wirk_ch.vorlage_therapie_id = vt_wirk_str.vorlage_therapie_id AND vt_wirk_ch.art = 'zyk' AND (                                                                           (vt_wirk_ch.zyklus_beginn <= vt_wirk_str.zyklus_beginn AND                                                                           vt_wirk_str.zyklus_beginn <= (vt_wirk_ch.zyklus_beginn + vt_wirk_ch.zyklus_anzahl)) OR                                                                           (vt_wirk_str.zyklus_beginn <= vt_wirk_ch.zyklus_beginn AND                                                                           vt_wirk_ch.zyklus_beginn <= (vt_wirk_str.zyklus_beginn + vt_wirk_str.zyklus_anzahl))                                                                        )            WHERE vt.art ='cst'         ) x         GROUP BY grp      ";      $result               = reset(sql_query_array($this->_db, $query));      $simRadioChemoInclude = strlen($result['vorlage_therapie_ids']) > 0 ? "IN ({$result['vorlage_therapie_ids']})" : 'IS NULL';      $simRadioChemoExclude = strlen($result['vorlage_therapie_ids']) > 0 ? "NOT IN ({$result['vorlage_therapie_ids']})" : 'IS NOT NULL';      $koloskopies         = $this->_getKoloskopieIds();      $additionalContent['fields'] = array(         "sit.m AS 'm'",         "sit.g AS 'g'",         "sit.lkk12  AS 'lkk12'",         "sit.lkue12 AS 'lkue12'",         "GROUP_CONCAT(DISTINCT                IF(                    s.form = 'eingriff' AND s.form_id IN ({$koloskopies}),                    s.form_id,                    NULL                )            SEPARATOR ',') AS 'th_kolos_e'",         "GROUP_CONCAT(DISTINCT IF(({$koloskopieUntersuchungClause}), u.untersuchung_id, NULL)) AS 'th_kolos_u'",         "GROUP_CONCAT(DISTINCT IF(k.eingriff_id IS NOT NULL, k.eingriff_id, NULL)) AS 'komp_kolos_e'",         "GROUP_CONCAT(DISTINCT IF(k.untersuchung_id IS NOT NULL, k.untersuchung_id, NULL)) AS 'komp_kolos_u'",         "GROUP_CONCAT(DISTINCT IF(LEFT(u.art, 5) = '1-650' OR u.art = '1-652.1', u.untersuchung_id, NULL)) AS 'diag_kolos_u'",         //Nebenwirkungen         "GROUP_CONCAT(DISTINCT IF(nw.strahlentherapie_id IS NOT NULL,     CONCAT_WS('|', nw.nci_code, nw.strahlentherapie_id),    NULL)) AS 'nebenwirkung_strahlen'",         "GROUP_CONCAT(DISTINCT IF(nw.therapie_systemisch_id IS NOT NULL,  CONCAT_WS('|', nw.nci_code, nw.therapie_systemisch_id), NULL)) AS 'nebenwirkung_systemisch'",         "GROUP_CONCAT(DISTINCT IF(nw.sonstige_therapie_id IS NOT NULL,    CONCAT_WS('|', nw.nci_code, nw.sonstige_therapie_id),   NULL)) AS 'nebenwirkung_sonstige'",         //alleinige Strahlentherapien         "GROUP_CONCAT(DISTINCT IF(th_str.strahlentherapie_id IS NOT NULL AND th_str.vorlage_therapie_id {$simRadioChemoExclude}, CONCAT_WS('|', th_str.strahlentherapie_id, th_str.vorlage_therapie_id), NULL)) AS 'str_th_p_nebenwirkung'",         //radiochemo Strahlentherapien         "GROUP_CONCAT(DISTINCT IF(th_str.strahlentherapie_id IS NOT NULL AND th_str.vorlage_therapie_id {$simRadioChemoInclude}, CONCAT_WS('|', th_str.strahlentherapie_id, th_str.vorlage_therapie_id), NULL)) AS 'str_che_th_p_nebenwirkung'",         //Sonstige Therapien         "GROUP_CONCAT(DISTINCT IF(th_son.sonstige_therapie_id IS NOT NULL, th_son.sonstige_therapie_id, NULL)) AS 'son_th_p_nebenwirkung'",         //Systemische Therapien - Alle alleinigen Strahlentherapien         "GROUP_CONCAT(DISTINCT IF(th_sys.vorlage_therapie_art = 'st', CONCAT_WS('|', th_sys.therapie_systemisch_id, th_sys.vorlage_therapie_id), NULL)) AS 'str_vt'",         //Systemische Therapien - Alle dokumentierten radio/chemo strahlentherapien         "GROUP_CONCAT(DISTINCT IF(th_sys.vorlage_therapie_art = 'cst' AND th_sys.vorlage_therapie_id {$simRadioChemoInclude}, CONCAT_WS('|', th_sys.therapie_systemisch_id, th_sys.vorlage_therapie_id), NULL)) AS 'str_che_vt'",         //Systemische Therapien - Alle alleinigen Chemotherapien         "GROUP_CONCAT(DISTINCT IF(th_sys.vorlage_therapie_art = 'c', CONCAT_WS('|', th_sys.therapie_systemisch_id, th_sys.vorlage_therapie_id), NULL)) AS 'chemo_vt'",         //Systemische Therapien - Alle antihormonelle Therapien         "GROUP_CONCAT(DISTINCT IF(th_sys.vorlage_therapie_art IN ('ah', 'ahst') , CONCAT_WS('|', th_sys.therapie_systemisch_id, th_sys.vorlage_therapie_id), NULL)) AS 'ah_vt'",         //Systemische Therapien - Alle Immuntherapien         "GROUP_CONCAT(DISTINCT IF(th_sys.vorlage_therapie_art IN ('i', 'ist', 'ci'), CONCAT_WS('|', th_sys.therapie_systemisch_id, th_sys.vorlage_therapie_id), NULL)) AS 'i_vt'",         "COUNT(DISTINCT IF(op.schnellschnitt = '1', op.eingriff_id, NULL))   AS 'schnellschnitt_anz'",         "MIN(IF(op.schnellschnitt = '1', op.schnellschnitt_dauer, NULL))     AS 'schnellschnitt_min'",         "MAX(IF(op.schnellschnitt = '1', op.schnellschnitt_dauer, NULL))     AS 'schnellschnitt_max'",         "COUNT(DISTINCT IF(op.schnellschnitt = '1' AND op.schnellschnitt_dauer IS NOT NULL AND op.schnellschnitt_dauer > 30, op.eingriff_id, NULL))   AS 'schnellschnitt_gr30'",         "MIN(IF(op.schnellschnitt = '1' AND op.schnellschnitt_dauer IS NOT NULL AND op.schnellschnitt_dauer > 30, op.schnellschnitt_dauer, NULL)) AS 'schnellschnitt_gr30_min'",         "MAX(IF(op.schnellschnitt = '1' AND op.schnellschnitt_dauer IS NOT NULL AND op.schnellschnitt_dauer > 30, op.schnellschnitt_dauer, NULL)) AS 'schnellschnitt_gr30_max'",         "COUNT(DISTINCT IF(op.schnellschnitt = '1' AND op.schnellschnitt_dauer IS NOT NULL AND op.schnellschnitt_dauer <= 30, op.eingriff_id, NULL))   AS 'schnellschnitt_kl30'",         "MIN(IF(op.schnellschnitt = '1' AND op.schnellschnitt_dauer IS NOT NULL AND op.schnellschnitt_dauer <= 30, op.schnellschnitt_dauer, NULL)) AS 'schnellschnitt_kl30_min'",         "MAX(IF(op.schnellschnitt = '1' AND op.schnellschnitt_dauer IS NOT NULL AND op.schnellschnitt_dauer <= 30, op.schnellschnitt_dauer, NULL)) AS 'schnellschnitt_kl30_max'",         //p = possible   biopsie u/e histologiee         "GROUP_CONCAT(DISTINCT IF(p_biopsie_u_histos.histologie_id IS NOT NULL, CONCAT_WS('|', p_biopsie_u_histos.datum, p_biopsie_u_histos.untersuchung_id), NULL))   AS 'p_biopsie_u_histos'",         "GROUP_CONCAT(DISTINCT IF(p_biopsie_e_histos.histologie_id IS NOT NULL, CONCAT_WS('|', p_biopsie_e_histos.datum, p_biopsie_e_histos.eingriff_id), NULL))       AS 'p_biopsie_e_histos'",         "GROUP_CONCAT(DISTINCT IF(biopsie_untersuchung.untersuchung_id IS NOT NULL, CONCAT_WS('|', biopsie_untersuchung.untersuchung_id, biopsie_untersuchung.datum), NULL)) AS 'biopsie_untersuchungen'",         "GROUP_CONCAT(            DISTINCT IF(                 s.form = 'eingriff' AND                 (                 LOCATE('1-556',    SUBSTRING(s.report_param, 5)) != 0 OR                 LOCATE('1-557.0',  SUBSTRING(s.report_param, 5)) != 0 OR                 LOCATE('1-444',    SUBSTRING(s.report_param, 5)) != 0 OR                 LOCATE('1-446',    SUBSTRING(s.report_param, 5)) != 0 OR                 LOCATE('1-695.2',  SUBSTRING(s.report_param, 5)) != 0                 ),                 CONCAT_WS('|', s.form_id, s.form_date),                 NULL            )         ) AS 'biopsie_eingriffe'",         "GROUP_CONCAT(            DISTINCT IF(                 s.form = 'eingriff' AND                 (                 LOCATE('5-452.0',  SUBSTRING(s.report_param, 5)) != 0 OR                 LOCATE('5-452.1',  SUBSTRING(s.report_param, 5)) != 0 OR                 LOCATE('5-455',    SUBSTRING(s.report_param, 5)) != 0 OR                 LOCATE('5-456',    SUBSTRING(s.report_param, 5)) != 0 OR                 LOCATE('5-456.1',  SUBSTRING(s.report_param, 5)) != 0 OR                 LOCATE('5-470',    SUBSTRING(s.report_param, 5)) != 0 OR                 LOCATE('5-484',    SUBSTRING(s.report_param, 5)) != 0 OR                 LOCATE('5-485',    SUBSTRING(s.report_param, 5)) != 0 OR                 LOCATE('5-458',  SUBSTRING(s.report_param, 5)) != 0                 ),                 CONCAT_WS('|', s.form_id, s.form_date),                 NULL            )         ) AS 'praeparat_eingriffe'",         "MIN(IF(h.art = 'pr' AND h.morphologie IS NOT NULL, h.datum, NULL)) AS 'praeop_morpho_histo'",         "MIN(IF(op.art_primaertumor = 1, op.datum, NULL)) AS 'primaereingriff'",         "GROUP_CONCAT(DISTINCT IF(p_praeparate_e_histos.histologie_id IS NOT NULL, CONCAT_WS('|', p_praeparate_e_histos.datum, p_praeparate_e_histos.eingriff_id), NULL))       AS 'p_praeparat_e_histos'",         "GROUP_CONCAT(DISTINCT IF(op.eingriff_id IS NOT NULL AND (op.operateur1_id IS NOT NULL OR op.operateur2_id IS NOT NULL) AND 1 IN (op.art_primaertumor, op.art_rezidiv), CONCAT_WS('', op.operateur1_id,'|', op.operateur2_id) , NULL)) AS 'operateure'",      );      $additionalContent['joins'] = array(         "LEFT JOIN nebenwirkung nw ON nw.erkrankung_id = sit.erkrankung_id",         "LEFT JOIN histologie p_biopsie_u_histos   ON s.form = 'histologie' AND p_biopsie_u_histos.histologie_id  = s.form_id AND p_biopsie_u_histos.art = 'pr' AND p_biopsie_u_histos.untersuchung_id IS NOT NULL",         "LEFT JOIN histologie p_biopsie_e_histos   ON s.form = 'histologie' AND p_biopsie_e_histos.histologie_id  = s.form_id AND p_biopsie_e_histos.art = 'pr' AND p_biopsie_e_histos.eingriff_id IS NOT NULL",         "LEFT JOIN histologie p_praeparate_e_histos   ON s.form = 'histologie' AND p_praeparate_e_histos.histologie_id  = s.form_id AND p_praeparate_e_histos.art = 'po' AND p_praeparate_e_histos.eingriff_id IS NOT NULL",         "LEFT JOIN untersuchung biopsie_untersuchung    ON s.form = 'untersuchung' AND biopsie_untersuchung.untersuchung_id  = s.form_id AND                                                           (                                                            LOCATE('1-556',    biopsie_untersuchung.art) != 0 OR                                                            LOCATE('1-557.0',  biopsie_untersuchung.art) != 0 OR                                                            LOCATE('1-444',    biopsie_untersuchung.art) != 0 OR                                                            LOCATE('1-446',    biopsie_untersuchung.art) != 0 OR                                                            LOCATE('1-695.2',  biopsie_untersuchung.art) != 0                                                           )"      );      $data = $this->loadRessource('d01', $additionalContent);      $this->_count = count($data);      $this->_initValues();      $operateurData       = array();      foreach ($data as $dataset)      {         $diagnose      = strlen($dataset['zugeordnet_zu']) ? $dataset['zugeordnet_zu'] : $dataset['diagnose'];         $diagnoseSub   = substr($diagnose, 0, 3);         //Dignitaet         $this->_values['dignitaet']['count']++;         $this->_values['dignitaet']['val']['alle']++;         $this->_values['dignitaet']['val']['in_situ'] += (int) (substr($dataset['icd_o_3'], -2) == '/2');         $this->_values['dignitaet']['val']['maligne'] += (int) (substr($dataset['icd_o_3'], -2) == '/3');         $this->_values['dignitaet']['val']['sonstige'] += (int) (strlen($dataset['icd_o_3']) > 0 && in_array(substr($dataset['icd_o_3'], -2), array('/2', '/3')) === false);         $this->_values['dignitaet']['val']['keine_angabe'] += (int) (strlen($dataset['icd_o_3']) == 0);         if (in_array($diagnoseSub, array('C18', 'C19', 'C20')) === true) {             //d03.15 präoperative Abklärung der Dignität             if ($dataset['operativer_fall_kolon'] == '1' || $dataset['operativer_fall_rektum'] == '1') {                $this->_values['praeop_dignitaet']['count']++;                $this->_values['praeop_dignitaet']['val']['alle_op_prim']++;                if (strlen($dataset['praeop_morpho_histo']) > 0 && strlen($dataset['primaereingriff']) > 0 && date_diff_days($dataset['praeop_morpho_histo'], $dataset['primaereingriff']) > 0) {                   $this->_values['praeop_dignitaet']['val']['praeop_abgeklaert']++;                }             }            //Nebenwirkungen Init.            $nebenwirkung = array(               'str'    => array('count' => array(), 'val' => array(), 'strpool' => array(), 'syspool' => array()),               'chemo'  => array('count' => array(), 'val' => array(),'syspool' => array()),               'ah'     => array('count' => array(), 'val' => array(),'syspool' => array()),               'i'      => array('count' => array(), 'val' => array(),'syspool' => array()),               'str_che' => array('count' => array(), 'val' => array(),'strpool' => array(), 'syspool' => array()),            );            //Alleinige Strahlentherapie verarbeiten            $strahlenarten = array('str', 'str_che');            foreach ($strahlenarten as $art) {               if (strlen($dataset["{$art}_th_p_nebenwirkung"]) > 0) {                  foreach (explode(',', $dataset["{$art}_th_p_nebenwirkung"]) as $strahlentherapie) {                     $ident = explode('|', $strahlentherapie);                     $nebenwirkung[$art]['count'][end($ident)] = 1;                     $nebenwirkung[$art]['strpool'][reset($ident)] = end($ident);                  }                  if (strlen($dataset['nebenwirkung_strahlen']) > 0) {                     foreach (explode(',', $dataset['nebenwirkung_strahlen']) as $nwContent) {                        $nwContent = explode('|', $nwContent);                        if (array_key_exists(end($nwContent), $nebenwirkung[$art]['strpool']) === true) {                           $vorlageTherapieId = $nebenwirkung[$art]['strpool'][end($nwContent)];                           $nebenwirkung[$art]['val'][reset($nwContent)][$vorlageTherapieId] = 1;                        }                     }                  }               }            }            $nebenwirkungSysTherapie = strlen($dataset['nebenwirkung_systemisch']) > 0 ? explode(',', $dataset['nebenwirkung_systemisch']) : array();            foreach ($nebenwirkung as $nwName => $nwData) {               if (strlen($dataset["{$nwName}_vt"]) > 0) {                  foreach (explode(',', $dataset["{$nwName}_vt"]) as $systemischeTherapie) {                     $ident = explode('|', $systemischeTherapie);                     $nebenwirkung[$nwName]['count'][end($ident)] = 1;                     $nebenwirkung[$nwName]['syspool'][reset($ident)] = end($ident);                  }               }               foreach ($nebenwirkungSysTherapie as $nwContent) {                  $nwContent = explode('|', $nwContent);                  if (array_key_exists(end($nwContent), $nebenwirkung[$nwName]['syspool']) === true) {                     $vorlageTherapieId = $nebenwirkung[$nwName]['syspool'][end($nwContent)];                     $nebenwirkung[$nwName]['val'][reset($nwContent)][$vorlageTherapieId] = 1;                  }               }            }            //Nebenwirkungen noch verarbeiten            foreach ($nebenwirkung as $nwName => $nwContent) {               $this->_values["nw_{$nwName}"]['count'] += count($nwContent['count']);               foreach ($nwContent['val'] as $nw => $count) {                  if (array_key_exists($nw, $this->_values["nw_{$nwName}"]['val']) === false) {                     $this->_values["nw_{$nwName}"]['val'][$nw] = count($count);                  } else {                     $this->_values["nw_{$nwName}"]['val'][$nw] += count($count);                  }               }            }            //Nebenwirkung sonstige            if (strlen($dataset['son_th_p_nebenwirkung']) > 0) {               $this->_values['nw_st']['count'] += count(explode(',', $dataset['son_th_p_nebenwirkung']));               if (strlen($dataset['nebenwirkung_sonstige']) > 0) {                  foreach (explode(',', $dataset['nebenwirkung_sonstige']) as $nwContent) {                     $nwContent = explode('|', $nwContent);                     //Daten werden später nochmal umgewandelt                     $this->_values['nw_st']['val'][reset($nwContent)][end($nwContent)] = 1;                  }               }            }            //pt            $this->_values['pt']['count']++;            $this->_values['pt']['val']['alle']++;            $this->_values['pt']['val']['pT0']           += (int) ($dataset['pt'] == 'pT0');            $this->_values['pt']['val']['pTis']          += (int) ($dataset['pt'] == 'pTis');            $this->_values['pt']['val']['pT1']           += (int) ($dataset['pt'] == 'pT1');            $this->_values['pt']['val']['pT2']           += (int) ($dataset['pt'] == 'pT2');            $this->_values['pt']['val']['pT3']           += (int) ($dataset['pt'] == 'pT3');            $this->_values['pt']['val']['pT4']           += (int) ($dataset['pt'] == 'pT4');            $this->_values['pt']['val']['pT4a']          += (int) ($dataset['pt'] == 'pT4a');            $this->_values['pt']['val']['pT4b']          += (int) ($dataset['pt'] == 'pT4b');            $this->_values['pt']['val']['pTX']           += (int) ($dataset['pt'] == 'pTX');            $this->_values['pt']['val']['keine_angabe']  += (int) (strlen($dataset['pt']) == 0);            $this->_values['pt']['val']['keine_op']      += (int) (strlen($dataset['pt']) == 0 && strlen($dataset['datum_primaer_op_rezidiv_op']) == 0);            //pn            $this->_values['pn']['count']++;            $this->_values['pn']['val']['alle']++;            $this->_values['pn']['val']['pN0']           += (int) ($dataset['pn'] == 'pN0');            $this->_values['pn']['val']['pN1']           += (int) ($dataset['pn'] == 'pN1');            $this->_values['pn']['val']['pN1a']          += (int) ($dataset['pn'] == 'pN1a');            $this->_values['pn']['val']['pN1b']          += (int) ($dataset['pn'] == 'pN1b');            $this->_values['pn']['val']['pN1c']          += (int) ($dataset['pn'] == 'pN1c');            $this->_values['pn']['val']['pN2']           += (int) ($dataset['pn'] == 'pN2');            $this->_values['pn']['val']['pN2a']          += (int) ($dataset['pn'] == 'pN2a');            $this->_values['pn']['val']['pN2b']          += (int) ($dataset['pn'] == 'pN2b');            $this->_values['pn']['val']['pNX']           += (int) ($dataset['pn'] == 'pNX');            $this->_values['pn']['val']['keine_angabe']  += (int) (strlen($dataset['pn']) == 0);            $this->_values['pn']['val']['keine_op']      += (int) (strlen($dataset['pn']) == 0 && strlen($dataset['datum_primaer_op_rezidiv_op']) == 0);            //m            $this->_values['m']['count']++;            $this->_values['m']['val']['alle']++;            $this->_values['m']['val']['M0']             += (int) (substr($dataset['m'], 1) == 'M0');            $this->_values['m']['val']['M1']             += (int) (substr($dataset['m'], 1) == 'M1');            $this->_values['m']['val']['M1a']            += (int) (substr($dataset['m'], 1) == 'M1a');            $this->_values['m']['val']['M1b']            += (int) (substr($dataset['m'], 1) == 'M1b');            $this->_values['m']['val']['MX']             += (int) (substr($dataset['m'], 1) == 'MX');            $this->_values['m']['val']['keine_angabe']   += (int) (strlen($dataset['m']) == 0);            //g            $this->_values['g']['count']++;            $this->_values['g']['val']['alle']++;            $this->_values['g']['val']['gX']             += (int) ($dataset['g'] == 'X');            $this->_values['g']['val']['g1']             += (int) ($dataset['g'] == '1');            $this->_values['g']['val']['g2']             += (int) ($dataset['g'] == '2');            $this->_values['g']['val']['g3']             += (int) ($dataset['g'] == '3');            $this->_values['g']['val']['g4']             += (int) ($dataset['g'] == '4');            $this->_values['g']['val']['keine_angabe']   += (int) (strlen($dataset['g']) == 0);            //uicc            $this->_values['uicc']['count']++;            $this->_values['uicc']['val']['alle']++;            $this->_values['uicc']['val']['uicc_0']             += (int) ($dataset['uicc'] == '0');            $this->_values['uicc']['val']['uicc_I']             += (int) ($dataset['uicc'] == 'I');            $this->_values['uicc']['val']['uicc_IIA']           += (int) ($dataset['uicc'] == 'IIA');            $this->_values['uicc']['val']['uicc_IIB']           += (int) ($dataset['uicc'] == 'IIB');            $this->_values['uicc']['val']['uicc_IIC']           += (int) ($dataset['uicc'] == 'IIC');            $this->_values['uicc']['val']['uicc_III']           += (int) ($dataset['uicc'] == 'III');            $this->_values['uicc']['val']['uicc_IIIA']          += (int) ($dataset['uicc'] == 'IIIA');            $this->_values['uicc']['val']['uicc_IIIB']          += (int) ($dataset['uicc'] == 'IIIB');            $this->_values['uicc']['val']['uicc_IIIC']          += (int) ($dataset['uicc'] == 'IIIC');            $this->_values['uicc']['val']['uicc_IV']            += (int) ($dataset['uicc'] == 'IV');            $this->_values['uicc']['val']['keine_angabe']  += (int) (strlen($dataset['uicc']) == 0);            //komplikationsrate ther. koloskopie            $this->_values['krthk']['count']              += (int) $dataset['ther_koloskopie'];            $this->_values['krthk']['thkol']              += (int) $dataset['ther_koloskopie'];            $th_kolos_komp = 0;            //Therap. Koloskopie Komplikation            if (strlen($dataset['th_kolos_e']) > 0 && strlen($dataset['komp_kolos_e']) > 0) {               $eingriffKolos = explode(',', $dataset['th_kolos_e']);               $kompKolos = explode(',', $dataset['komp_kolos_e']);               foreach ($kompKolos as $komp) {                  if (in_array($komp, $eingriffKolos) === true) {                     $th_kolos_komp++;                  }               }            }            if (strlen($dataset['th_kolos_u']) > 0 && strlen($dataset['komp_kolos_u']) > 0) {               $untersuchungKolos = explode(',', $dataset['th_kolos_u']);               $kompKolos = explode(',', $dataset['komp_kolos_u']);               foreach ($kompKolos as $komp) {                  if (in_array($komp, $untersuchungKolos) === true) {                     $th_kolos_komp++;                  }               }            }            $this->_values['krthk']['val']                += $th_kolos_komp;            //Komplikationsrate diag. koloskopie            $this->_values['krdiagk']['count']            += (int) $dataset['anz_diagn_koloskopie'];            $this->_values['krdiagk']['diagkol']          += (int) $dataset['anz_diagn_koloskopie'];            $diag_kolos_komp = 0;            if (strlen($dataset['diag_kolos_u']) > 0 && strlen($dataset['komp_kolos_u']) > 0) {               $untersuchungKolos = explode(',', $dataset['diag_kolos_u']);               $kompKolos = explode(',', $dataset['komp_kolos_u']);               foreach ($kompKolos as $komp) {                  if (in_array($komp, $untersuchungKolos) === true) {                     $diag_kolos_komp++;                  }               }            }            $this->_values['krdiagk']['val']              += $diag_kolos_komp;            if ($dataset['operativer_fall_kolon'] == '1' || $dataset['operativer_fall_rektum'] == '1') {               $this->_values['lymph']['count']++;               $this->_values['lymph']['val']['alle_op']++;               $this->_values['lymph']['val']['lkue12']        += (int) ($dataset['lkue12']);               $this->_values['lymph']['val']['lkk12']         += (int) ($dataset['lkk12']);            }            //Schnellschnitt            $this->_values['schnellschnitt']['count']                += (int) $dataset['schnellschnitt_anz'];            $this->_values['schnellschnitt']['val']['alle_schnell']  += (int) $dataset['schnellschnitt_anz'];            $this->_values['schnellschnitt']['min']['alle_schnell']     = $this->_insert('min', $this->_values['schnellschnitt']['min']['alle_schnell'], $dataset['schnellschnitt_min']);            $this->_values['schnellschnitt']['max']['alle_schnell']     = $this->_insert('max', $this->_values['schnellschnitt']['max']['alle_schnell'], $dataset['schnellschnitt_max']);            $this->_values['schnellschnitt']['range']['alle_schnell']   = $this->_insert('range', $this->_values['schnellschnitt']['max']['alle_schnell'], $this->_values['schnellschnitt']['min']['alle_schnell']);            $this->_values['schnellschnitt']['val']['gr30']    += (int) $dataset['schnellschnitt_gr30'];            $this->_values['schnellschnitt']['min']['gr30']     = $this->_insert('min', $this->_values['schnellschnitt']['min']['gr30'], $dataset['schnellschnitt_gr30_min']);            $this->_values['schnellschnitt']['max']['gr30']     = $this->_insert('max', $this->_values['schnellschnitt']['max']['gr30'], $dataset['schnellschnitt_gr30_max']);            $this->_values['schnellschnitt']['range']['gr30']   = $this->_insert('range', $this->_values['schnellschnitt']['max']['gr30'], $this->_values['schnellschnitt']['min']['gr30']);            $this->_values['schnellschnitt']['val']['kl30']    += (int) $dataset['schnellschnitt_kl30'];            $this->_values['schnellschnitt']['min']['kl30']     = $this->_insert('min', $this->_values['schnellschnitt']['min']['kl30'], $dataset['schnellschnitt_kl30_min']);            $this->_values['schnellschnitt']['max']['kl30']     = $this->_insert('max', $this->_values['schnellschnitt']['max']['kl30'], $dataset['schnellschnitt_kl30_max']);            $this->_values['schnellschnitt']['range']['kl30']   = $this->_insert('range', $this->_values['schnellschnitt']['max']['kl30'], $this->_values['schnellschnitt']['min']['kl30']);            //Biopsie Eingriff            $biopsieEingriffe       = strlen($dataset['biopsie_eingriffe']) > 0  ? explode(',', $dataset['biopsie_eingriffe'])   : array();            $pbiopsieEingriffHistos = strlen($dataset['p_biopsie_e_histos']) > 0 ? explode(',', $dataset['p_biopsie_e_histos'])  : array();            if (count($biopsieEingriffe) > 0 && count($pbiopsieEingriffHistos) > 0) {               $be = array();               foreach ($biopsieEingriffe as $b) {                  $ident = explode('|', $b);                  $be[reset($ident)] = end($ident);               }               foreach ($pbiopsieEingriffHistos as $histo) {                  $ident   = explode('|', $histo);                  $date    = reset($ident);                  $uId     = end($ident);                  if (array_key_exists($uId, $be) === true) {                     $eingriffDatum = $be[$uId];                     $histoDatum = $date;                     $diff = getWorkdays($eingriffDatum, $histoDatum);                     $this->_values['biopsate']['count']++;                     $this->_values['biopsate']['val']['alle_biopsate']++;                     if ($diff >= 0 && $diff <= 3) {                        $this->_values['biopsate']['val']['kl3']++;                        $this->_values['biopsate']['min']['kl3']     = $this->_insert('min', $this->_values['biopsate']['min']['kl3'], $diff);                        $this->_values['biopsate']['max']['kl3']     = $this->_insert('max', $this->_values['biopsate']['max']['kl3'], $diff);                        $this->_values['biopsate']['range']['kl3']   = $this->_insert('range', $this->_values['biopsate']['max']['kl3'], $this->_values['biopsate']['min']['kl3']);                     } elseif($diff > 3) {                        $this->_values['biopsate']['val']['gr3']++;                        $this->_values['biopsate']['min']['gr3']     = $this->_insert('min', $this->_values['biopsate']['min']['gr3'], $diff);                        $this->_values['biopsate']['max']['gr3']     = $this->_insert('max', $this->_values['biopsate']['max']['gr3'], $diff);                        $this->_values['biopsate']['range']['gr3']   = $this->_insert('range', $this->_values['biopsate']['max']['gr3'], $this->_values['biopsate']['min']['gr3']);                     }                  }               }            }            //Biopsie Untersuchungen            $biopsieUntersuchungen        = strlen($dataset['biopsie_untersuchungen']) > 0   ? explode(',', $dataset['biopsie_untersuchungen']) : array();            $pbiopsieUntersuchungHistos   = strlen($dataset['p_biopsie_u_histos']) > 0       ? explode(',', $dataset['p_biopsie_u_histos'])     : array();            if (count($biopsieUntersuchungen) > 0 && count($pbiopsieUntersuchungHistos) > 0) {               $bu = array();               foreach ($biopsieUntersuchungen as $b) {                  $ident = explode('|', $b);                  $bu[reset($ident)] = end($ident);               }               foreach ($pbiopsieUntersuchungHistos as $histo) {                  $ident   = explode('|', $histo);                  $date    = reset($ident);                  $uId     = end($ident);                  if (array_key_exists($uId, $bu) === true) {                     $untersuchungDatum = $bu[$uId];                     $histoDatum = $date;                     $diff = getWorkdays($untersuchungDatum, $histoDatum);                     $this->_values['biopsate']['count']++;                     $this->_values['biopsate']['val']['alle_biopsate']++;                     if ($diff >= 0 && $diff <= 3) {                        $this->_values['biopsate']['val']['kl3']++;                        $this->_values['biopsate']['min']['kl3']     = $this->_insert('min', $this->_values['biopsate']['min']['kl3'], $diff);                        $this->_values['biopsate']['max']['kl3']     = $this->_insert('max', $this->_values['biopsate']['max']['kl3'], $diff);                        $this->_values['biopsate']['range']['kl3']   = $this->_insert('range', $this->_values['biopsate']['max']['kl3'], $this->_values['biopsate']['min']['kl3']);                     } elseif($diff > 3) {                        $this->_values['biopsate']['val']['gr3']++;                        $this->_values['biopsate']['min']['gr3']     = $this->_insert('min', $this->_values['biopsate']['min']['gr3'], $diff);                        $this->_values['biopsate']['max']['gr3']     = $this->_insert('max', $this->_values['biopsate']['max']['gr3'], $diff);                        $this->_values['biopsate']['range']['gr3']   = $this->_insert('range', $this->_values['biopsate']['max']['gr3'], $this->_values['biopsate']['min']['gr3']);                     }                  }               }            }            //Praeparat Eingriff            $praeparatEingriffe        = strlen($dataset['praeparat_eingriffe']) > 0  ? explode(',', $dataset['praeparat_eingriffe'])   : array();            $ppraeparatEingriffHistos  = strlen($dataset['p_praeparat_e_histos']) > 0 ? explode(',', $dataset['p_praeparat_e_histos'])  : array();            if (count($praeparatEingriffe) > 0 && count($ppraeparatEingriffHistos) > 0) {               $pe = array();               foreach ($praeparatEingriffe as $b) {                  $ident = explode('|', $b);                  $pe[reset($ident)] = end($ident);               }               foreach ($ppraeparatEingriffHistos as $histo) {                  $ident   = explode('|', $histo);                  $date    = reset($ident);                  $uId     = end($ident);                  if (array_key_exists($uId, $pe) === true) {                     $eingriffDatum = $pe[$uId];                     $histoDatum = $date;                     $diff = getWorkdays($eingriffDatum, $histoDatum);                     $this->_values['praeparate']['count']++;                     $this->_values['praeparate']['val']['alle_praeparate']++;                     if ($diff >= 0 && $diff <= 5) {                        $this->_values['praeparate']['val']['kl5']++;                        $this->_values['praeparate']['min']['kl5']     = $this->_insert('min', $this->_values['praeparate']['min']['kl5'], $diff);                        $this->_values['praeparate']['max']['kl5']     = $this->_insert('max', $this->_values['praeparate']['max']['kl5'], $diff);                        $this->_values['praeparate']['range']['kl5']   = $this->_insert('range', $this->_values['praeparate']['max']['kl5'], $this->_values['praeparate']['min']['kl5']);                     } elseif($diff > 5) {                        $this->_values['praeparate']['val']['gr5']++;                        $this->_values['praeparate']['min']['gr5']     = $this->_insert('min', $this->_values['praeparate']['min']['gr5'], $diff);                        $this->_values['praeparate']['max']['gr5']     = $this->_insert('max', $this->_values['praeparate']['max']['gr5'], $diff);                        $this->_values['praeparate']['range']['gr5']   = $this->_insert('range', $this->_values['praeparate']['max']['gr5'], $this->_values['praeparate']['min']['gr5']);                     }                  }               }            }         }         //Darmoperateure         if (in_array($diagnoseSub, array('C18', 'C20')) === true && strlen($dataset['operateure']) > 0) {            $opArten = explode(',', $dataset['operateure']);            foreach ($opArten as $art) {               $operateure = explode('|', $art);               //$x = 0 == 1.Operateur / $x = 1 == Assistenz               foreach ($operateure as $x => $operateur) {                  if (strlen($operateur) > 0) {                     //Initialisieren des op                     if (array_key_exists($operateur, $operateurData) === false) {                        $operateurData[$operateur] = $this->_buildOpArray();                     }                     $operateurData[$operateur]['val']++;                     $sec = $x == 0 ? 'operateur' : 'assi';                     $typ = $diagnoseSub == 'C18' ? 'colon' : 'rektum';                     $operateurData[$operateur]["op_{$typ}_gesamt"]++;                     $operateurData[$operateur]["op_{$typ}_{$sec}"]++;                  }               }            }         }      } //foreach end      //Nachverarbeitung der Daten      foreach ($this->_values['nw_st']['val'] as $nw => $nwCount) {         $this->_values['nw_st']['val'][$nw] = count($nwCount);      }      //Berechnung Biopsate range, min, max..      if ($this->_values['biopsate']['val']['alle_biopsate'] != 0) {         $this->_values['biopsate']['min']['alle_biopsate']     = $this->_insert('min', $this->_values['biopsate']['min']['kl3'], $this->_values['biopsate']['min']['gr3']);         $this->_values['biopsate']['max']['alle_biopsate']     = $this->_insert('max', $this->_values['biopsate']['max']['kl3'], $this->_values['biopsate']['max']['gr3']);         $this->_values['biopsate']['range']['alle_biopsate']   = $this->_insert('range', $this->_values['biopsate']['max']['alle_biopsate'], $this->_values['biopsate']['min']['alle_biopsate']);      }      //Berechnung Praeparate range, min, max..      if ($this->_values['praeparate']['val']['alle_praeparate'] != 0) {         $this->_values['praeparate']['min']['alle_praeparate']     = $this->_insert('min', $this->_values['praeparate']['min']['kl5'], $this->_values['praeparate']['min']['gr5']);         $this->_values['praeparate']['max']['alle_praeparate']     = $this->_insert('max', $this->_values['praeparate']['max']['kl5'], $this->_values['praeparate']['max']['gr5']);         $this->_values['praeparate']['range']['alle_praeparate']   = $this->_insert('range', $this->_values['praeparate']['max']['alle_praeparate'], $this->_values['praeparate']['min']['alle_praeparate']);      }      //Zuweisung Operateure      foreach ($operateurData as $arzt => $op) {         $this->_values['operateure']['val'][$arzt]            = $op['val'];         $this->_values['operateure']['op_colon_gesamt'][]     = $op['op_colon_gesamt'];         $this->_values['operateure']['op_colon_operateur'][]  = $op['op_colon_operateur'];         $this->_values['operateure']['op_colon_assi'][]       = $op['op_colon_assi'];         $this->_values['operateure']['op_rektum_gesamt'][]    = $op['op_rektum_gesamt'];         $this->_values['operateure']['op_rektum_operateur'][] = $op['op_rektum_operateur'];         $this->_values['operateure']['op_rektum_assi'][]      = $op['op_rektum_assi'];      }      //Chemotherapien      $chemotherapien = $this->loadRessource('chemotherapien');      foreach ($chemotherapien AS $chemoTherapy) {         $org = $chemoTherapy['org_id'];         $dDisease = $chemoTherapy['d'];         $this->_values['chemo_d']['val'][$org] = isset($this->_values['chemo_d']['val'][$org]) === true            ? $this->_values['chemo_d']['val'][$org] + 1            : 1         ;         if ($dDisease == '1') {             $this->_values['chemo_d_indikation']['val'][$org] = isset($this->_values['chemo_d_indikation']['val'][$org]) === true                ? $this->_values['chemo_d_indikation']['val'][$org] + 1                : 1             ;         }      }      require_once 'reports/pdf/d/d03/p1.php';      require_once 'reports/pdf/d/d03/p2.php';      require_once 'reports/pdf/d/d03/p3.php';   }   private function _insert($type, $src, $value, $default = '-')   {      $val = $src !== $default ? $src : $default;      switch ($type) {         case 'range':            if (is_int($src) == true && is_int($value) == true) {               $val = $src - $value;            }            break;         case 'max':         case 'min':            if (strlen($value) > 0) {               $value   = (int) $value;               $src     = $src !== $default ? $src : (                  $type == 'min' ? $value : 0               );               eval('$compare = $type == "max" ? ($value >= $src) : ($value <= $src);');               if ($compare == true) {                  $val = $value;               }            } else {               $val = $src;            }            break;      }      return $val;   }   private function _buildOpArray()   {      return array(         'val'                   => 0,         'op_colon_gesamt'       => 0,         'op_colon_operateur'    => 0,         'op_colon_assi'         => 0,         'op_rektum_gesamt'      => 0,         'op_rektum_operateur'   => 0,         'op_rektum_assi'        => 0      );   }}?>