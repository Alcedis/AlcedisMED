<?php/*
 * AlcedisMED
 * Copyright (C) 2010-2016  Alcedis GmbH
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */ 

class reportContentP03 extends reportExtensionP{   protected $_values = array();   public function init(alcReportPdf $renderer){      $renderer->addPage();   }   private function _initValues()   {      $percentArray = array(         'dignitaet'     => array('val' => array('alle', 'in_situ', 'maligne', 'sonstige', 'keine_angabe')),         'pt'            => array('val' => array('alle', 'pT0', 'pT1', 'pT1a', 'pT1b', 'pT1c', 'pT2', 'pT2a', 'pT2b', 'pT2c', 'pT3', 'pT3a', 'pT3b', 'pT4', 'pTX', 'keine_angabe', 'keine_op')),         'pn'            => array('val' => array('alle', 'pN0', 'pN1', 'pNX', 'keine_angabe')),         'm'             => array('val' => array('alle', 'M0', 'M1', 'M1a', 'M1b', 'M1c', 'MX', 'keine_angabe')),         'g'             => array('val' => array('alle', 'gX', 'g1', 'g2', 'g34', 'keine_angabe')),         'interdis_ang'  => array('val' => array('interdis_angeboten')),         'stanzen'       => array('val' => array('alle_stanzen', 'positiv', 'min10')),         'biopsate' => array(            'val'    => array('alle_biopsate', 'gr5', 'kl5'),            'min'    => array('alle_biopsate' => '-', 'gr5' => '-', 'kl5' => '-'),            'max'    => array('alle_biopsate' => '-', 'gr5' => '-', 'kl5' => '-'),            'range'  => array('alle_biopsate' => '-', 'gr5' => '-', 'kl5' => '-')         ),         'praeparate' => array(            'val'    => array('alle_praeparate', 'gr7', 'kl7'),            'min'    => array('alle_praeparate' => '-', 'gr7' => '-', 'kl7' => '-'),            'max'    => array('alle_praeparate' => '-', 'gr7' => '-', 'kl7' => '-'),            'range'  => array('alle_praeparate' => '-', 'gr7' => '-', 'kl7' => '-')         ),         'ptpn_invasiv'  => array('val' => array('alle', 'ptpn')),         'resektion'    => array('val' => array('alle', 'r0', 'r1', 'abstand')),         'operateure' => array(            'val'               => array(),            'op_operateur'      => array(),            'op_assi'           => array(),            'op_assi_anteil'    => array(),         ),         'chemo_p_indikation'    => array('val' => array()),      );      $this         ->_initPercentArray($percentArray)      ;      return $this;   }   public function generate($renderer)   {      $renderer->setConfig($this->loadConfigs('p03', false, true));      $dataCache = array();      $additionalContent = array();      $additionalContent['selects'] = array(        "(SELECT SUBSTRING(ts.t, 2) FROM tumorstatus ts WHERE ts.erkrankung_id = t.erkrankung_id AND ts.anlass = t.anlass AND ts.t IS NOT NULL         ORDER BY ts.datum_sicherung DESC, ts.sicherungsgrad ASC, ts.datum_beurteilung DESC LIMIT 1) AS t",        "(SELECT SUBSTRING(ts.n, 2) FROM tumorstatus ts WHERE ts.erkrankung_id = t.erkrankung_id AND ts.anlass = t.anlass AND ts.n IS NOT NULL         ORDER BY ts.datum_sicherung DESC, ts.sicherungsgrad ASC, ts.datum_beurteilung DESC LIMIT 1) AS n",      );      $stanzen = "        IF(hstanz.sbr_1_laenge >= 10,1,0) + IF(hstanz.sbr_2_laenge >= 10,1,0) + IF(hstanz.sbr_3_laenge >= 10,1,0) + IF(hstanz.sbr_4_laenge >= 10,1,0) + IF(hstanz.sbr_5_laenge >= 10,1,0) +        IF(hstanz.sbl_1_laenge >= 10,1,0) + IF(hstanz.sbl_2_laenge >= 10,1,0) + IF(hstanz.sbl_3_laenge >= 10,1,0) + IF(hstanz.sbl_4_laenge >= 10,1,0) + IF(hstanz.sbl_5_laenge >= 10,1,0) +        IF(hstanz.blr_1_laenge >= 10,1,0) + IF(hstanz.blr_2_laenge >= 10,1,0) + IF(hstanz.blr_3_laenge >= 10,1,0) + IF(hstanz.blr_4_laenge >= 10,1,0) + IF(hstanz.blr_5_laenge >= 10,1,0) +        IF(hstanz.bll_1_laenge >= 10,1,0) + IF(hstanz.bll_2_laenge >= 10,1,0) + IF(hstanz.bll_3_laenge >= 10,1,0) + IF(hstanz.bll_4_laenge >= 10,1,0) + IF(hstanz.bll_5_laenge >= 10,1,0) +        IF(hstanz.br_1_laenge  >= 10,1,0) + IF(hstanz.br_2_laenge  >= 10,1,0) + IF(hstanz.br_3_laenge  >= 10,1,0) + IF(hstanz.br_4_laenge  >= 10,1,0) + IF(hstanz.br_5_laenge  >= 10,1,0) +        IF(hstanz.bl_1_laenge  >= 10,1,0) + IF(hstanz.bl_2_laenge  >= 10,1,0) + IF(hstanz.bl_3_laenge  >= 10,1,0) + IF(hstanz.bl_4_laenge  >= 10,1,0) + IF(hstanz.bl_5_laenge  >= 10,1,0) +        IF(hstanz.tr_1_laenge  >= 10,1,0) + IF(hstanz.tr_2_laenge  >= 10,1,0) + IF(hstanz.tr_3_laenge  >= 10,1,0) + IF(hstanz.tr_4_laenge  >= 10,1,0) + IF(hstanz.tr_5_laenge  >= 10,1,0) +        IF(hstanz.tl_1_laenge  >= 10,1,0) + IF(hstanz.tl_2_laenge  >= 10,1,0) + IF(hstanz.tl_3_laenge  >= 10,1,0) + IF(hstanz.tl_4_laenge  >= 10,1,0) + IF(hstanz.tl_5_laenge  >= 10,1,0) +        IF(hstanz.mlr_1_laenge >= 10,1,0) + IF(hstanz.mlr_2_laenge >= 10,1,0) + IF(hstanz.mlr_3_laenge >= 10,1,0) + IF(hstanz.mlr_4_laenge >= 10,1,0) + IF(hstanz.mlr_5_laenge >= 10,1,0) +        IF(hstanz.mll_1_laenge >= 10,1,0) + IF(hstanz.mll_2_laenge >= 10,1,0) + IF(hstanz.mll_3_laenge >= 10,1,0) + IF(hstanz.mll_4_laenge >= 10,1,0) + IF(hstanz.mll_5_laenge >= 10,1,0) +        IF(hstanz.mr_1_laenge  >= 10,1,0) + IF(hstanz.mr_2_laenge  >= 10,1,0) + IF(hstanz.mr_3_laenge  >= 10,1,0) + IF(hstanz.mr_4_laenge  >= 10,1,0) + IF(hstanz.mr_5_laenge  >= 10,1,0) +        IF(hstanz.ml_1_laenge  >= 10,1,0) + IF(hstanz.ml_2_laenge  >= 10,1,0) + IF(hstanz.ml_3_laenge  >= 10,1,0) + IF(hstanz.ml_4_laenge  >= 10,1,0) + IF(hstanz.ml_5_laenge  >= 10,1,0) +        IF(hstanz.alr_1_laenge >= 10,1,0) + IF(hstanz.alr_2_laenge >= 10,1,0) + IF(hstanz.alr_3_laenge >= 10,1,0) + IF(hstanz.alr_4_laenge >= 10,1,0) + IF(hstanz.alr_5_laenge >= 10,1,0) +        IF(hstanz.all_1_laenge >= 10,1,0) + IF(hstanz.all_2_laenge >= 10,1,0) + IF(hstanz.all_3_laenge >= 10,1,0) + IF(hstanz.all_4_laenge >= 10,1,0) + IF(hstanz.all_5_laenge >= 10,1,0) +        IF(hstanz.ar_1_laenge  >= 10,1,0) + IF(hstanz.ar_2_laenge  >= 10,1,0) + IF(hstanz.ar_3_laenge  >= 10,1,0) + IF(hstanz.ar_4_laenge  >= 10,1,0) + IF(hstanz.ar_5_laenge  >= 10,1,0) +        IF(hstanz.al_1_laenge  >= 10,1,0) + IF(hstanz.al_2_laenge  >= 10,1,0) + IF(hstanz.al_3_laenge  >= 10,1,0) + IF(hstanz.al_4_laenge  >= 10,1,0) + IF(hstanz.al_5_laenge  >= 10,1,0)      ";      $histologieFilter = $this->_getVonDate() !== null && $this->_getBisDate() !== null         ? " AND hstanz.datum BETWEEN '{$this->_getVonDate()}' AND '{$this->_getBisDate()}'"         : ($this->_getVonDate() !== null            ? " AND hstanz.datum >= '{$this->_getVonDate()}'"            : ($this->_getBisDate() !== null                ? " AND hstanz.datum <= '{$this->_getBisDate()}'"                : ''            )         )      ;      $additionalContent['fields'] = array(         "sit.anlass AS 'sit_anlass'",         "sit.t",         "sit.n",         "sit.resektionsrand",          //p = possible   biopsie u/e histologiee         "GROUP_CONCAT(DISTINCT IF(p_biopsie_u_histos.histologie_id IS NOT NULL, CONCAT_WS('|', p_biopsie_u_histos.datum, p_biopsie_u_histos.untersuchung_id), NULL))   AS 'p_biopsie_u_histos'",         "GROUP_CONCAT(DISTINCT IF(p_biopsie_e_histos.histologie_id IS NOT NULL, CONCAT_WS('|', p_biopsie_e_histos.datum, p_biopsie_e_histos.eingriff_id), NULL))       AS 'p_biopsie_e_histos'",         "GROUP_CONCAT(DISTINCT IF(biopsie_untersuchung.untersuchung_id IS NOT NULL, CONCAT_WS('|', biopsie_untersuchung.untersuchung_id, biopsie_untersuchung.datum), NULL)) AS 'biopsie_untersuchungen'",         "GROUP_CONCAT(            DISTINCT IF(                 s.form = 'eingriff' AND LOCATE('1-464.0', SUBSTRING(s.report_param, 5)) != 0,                 CONCAT_WS('|', s.form_id, s.form_date),                 NULL            )         ) AS 'biopsie_eingriffe'",        "GROUP_CONCAT(            DISTINCT IF(                 s.form = 'eingriff' AND LOCATE('5-604',  SUBSTRING(s.report_param, 5)) != 0,                 CONCAT_WS('|', s.form_id, s.form_date),                 NULL            )         ) AS 'praeparat_eingriffe'",        "GROUP_CONCAT(DISTINCT IF(p_praeparate_e_histos.histologie_id IS NOT NULL, CONCAT_WS('|', p_praeparate_e_histos.datum, p_praeparate_e_histos.eingriff_id), NULL))       AS 'p_praeparat_e_histos'",      );      $additionalContent['joins'] = array(        "LEFT JOIN histologie p_biopsie_u_histos   ON s.form = 'histologie' AND p_biopsie_u_histos.histologie_id  = s.form_id AND p_biopsie_u_histos.art = 'pr' AND p_biopsie_u_histos.untersuchung_id IS NOT NULL",        "LEFT JOIN histologie p_biopsie_e_histos   ON s.form = 'histologie' AND p_biopsie_e_histos.histologie_id  = s.form_id AND p_biopsie_e_histos.art = 'pr' AND p_biopsie_e_histos.eingriff_id IS NOT NULL",        "LEFT JOIN histologie p_praeparate_e_histos   ON s.form = 'histologie' AND p_praeparate_e_histos.histologie_id  = s.form_id AND p_praeparate_e_histos.art = 'po' AND p_praeparate_e_histos.eingriff_id IS NOT NULL",        "LEFT JOIN untersuchung biopsie_untersuchung    ON s.form = 'untersuchung' AND biopsie_untersuchung.untersuchung_id  = s.form_id AND LOCATE('1-464.0',  biopsie_untersuchung.art) != 0"      );      $data = $this->loadRessource('p01', $additionalContent);      $this->_count = count($data);      $this->_initValues();      $operateurData       = array();      $chemoIndikationData = array();      foreach ($data as $dataset) {         if ($dataset['sit_anlass'] == 'p') {             //Dignitaet             $this->_values['dignitaet']['count']++;             $this->_values['dignitaet']['val']['alle']++;             $this->_values['dignitaet']['val']['in_situ']      += (int) (substr($dataset['morphologie'], -2) == '/2');             $this->_values['dignitaet']['val']['maligne']      += (int) (substr($dataset['morphologie'], -2) == '/3');             $this->_values['dignitaet']['val']['sonstige']     += (int) (strlen($dataset['morphologie']) > 0 && in_array(substr($dataset['morphologie'], -2), array('/2', '/3')) === false);             $this->_values['dignitaet']['val']['keine_angabe'] += (int) (strlen($dataset['morphologie']) == 0);             //t             $this->_values['pt']['count']++;             $this->_values['pt']['val']['alle']++;             $this->_values['pt']['val']['pT0']            += (int) ($dataset['pt'] == 'pT0');             $this->_values['pt']['val']['pT1']            += (int) ($dataset['pt'] == 'pT1');             $this->_values['pt']['val']['pT1a']           += (int) ($dataset['pt'] == 'pT1a');             $this->_values['pt']['val']['pT1b']           += (int) ($dataset['pt'] == 'pT1b');             $this->_values['pt']['val']['pT1c']           += (int) ($dataset['pt'] == 'pT1c');             $this->_values['pt']['val']['pT2']            += (int) ($dataset['pt'] == 'pT2');             $this->_values['pt']['val']['pT2a']           += (int) ($dataset['pt'] == 'pT2a');             $this->_values['pt']['val']['pT2b']           += (int) ($dataset['pt'] == 'pT2b');             $this->_values['pt']['val']['pT2c']           += (int) ($dataset['pt'] == 'pT2c');             $this->_values['pt']['val']['pT3']            += (int) ($dataset['pt'] == 'pT3');             $this->_values['pt']['val']['pT3a']           += (int) ($dataset['pt'] == 'pT3a');             $this->_values['pt']['val']['pT3b']           += (int) ($dataset['pt'] == 'pT3b');             $this->_values['pt']['val']['pT4']            += (int) ($dataset['pt'] == 'pT4');             $this->_values['pt']['val']['pTX']            += (int) ($dataset['pt'] == 'pTX');             $this->_values['pt']['val']['keine_angabe']  += (int) (strlen($dataset['pt']) == 0);             $this->_values['pt']['val']['keine_op']      += (int) (strlen($dataset['pt']) == 0 && strlen($dataset['primaer_op']) == 0);             //n             $this->_values['pn']['count']++;             $this->_values['pn']['val']['alle']++;             $this->_values['pn']['val']['pN0']           += (int) ($dataset['pn'] == 'pN0');             $this->_values['pn']['val']['pN1']           += (int) ($dataset['pn'] == 'pN1');             $this->_values['pn']['val']['pNX']           += (int) ($dataset['pn'] == 'pNX');             $this->_values['pn']['val']['keine_angabe'] += (int) (strlen($dataset['pn']) == 0);             //$this->_values['n']['val']['keine_op']     += (int) (strlen($dataset['n']) == 0 && strlen($dataset['primaer_op']) == 0);             //m             $this->_values['m']['count']++;             $this->_values['m']['val']['alle']++;             $this->_values['m']['val']['M0']             += (int) (substr($dataset['m'], 1) == 'M0');             $this->_values['m']['val']['M1']             += (int) (substr($dataset['m'], 1) == 'M1');             $this->_values['m']['val']['M1a']            += (int) (substr($dataset['m'], 1) == 'M1a');             $this->_values['m']['val']['M1b']            += (int) (substr($dataset['m'], 1) == 'M1b');             $this->_values['m']['val']['M1c']            += (int) (substr($dataset['m'], 1) == 'M1c');             $this->_values['m']['val']['MX']             += (int) (substr($dataset['m'], 1) == 'MX');             $this->_values['m']['val']['keine_angabe']   += (int) (strlen($dataset['m']) == 0);             //g             $this->_values['g']['count']++;             $this->_values['g']['val']['alle']++;             $this->_values['g']['val']['gX']             += (int) ($dataset['g_original'] == 'X');             $this->_values['g']['val']['g1']             += (int) ($dataset['g_original'] == '1');             $this->_values['g']['val']['g2']             += (int) ($dataset['g_original'] == '2');             $this->_values['g']['val']['g34']            += (int) ($dataset['g_original'] == 'H');             $this->_values['g']['val']['keine_angabe']   += (int) (strlen($dataset['g_original']) == 0);         }         //Interdisziplinäres Gespräch         $this->_values['interdis_ang']['val']['interdis_angeboten'] += (int) ($dataset['interdisziplinaer_angeboten'] == '1');         if ($dataset['sit_anlass'] == 'p') {            $this->_values['stanzen']['count']++;            $this->_values['stanzen']['val']['alle_stanzen'] += (int) ($dataset['trus'] == 1);            $this->_values['stanzen']['val']['positiv'] += (int) ($dataset['stanzzylinder_positiv'] == 1);            $this->_values['stanzen']['val']['min10'] += (int) ($dataset['stanzzylinder_1_cm'] >= 10);         }        //Biopsie Eingriff        $biopsieEingriffe       = strlen($dataset['biopsie_eingriffe']) > 0  ? explode(',', $dataset['biopsie_eingriffe'])   : array();        $pbiopsieEingriffHistos = strlen($dataset['p_biopsie_e_histos']) > 0 ? explode(',', $dataset['p_biopsie_e_histos'])  : array();        if (count($biopsieEingriffe) > 0 && count($pbiopsieEingriffHistos) > 0) {           $be = array();           foreach ($biopsieEingriffe as $b) {              $ident = explode('|', $b);              $be[reset($ident)] = end($ident);           }           foreach ($pbiopsieEingriffHistos as $histo) {              $ident   = explode('|', $histo);              $date    = reset($ident);              $uId     = end($ident);              if (array_key_exists($uId, $be) === true) {                 $eingriffDatum = $be[$uId];                 $histoDatum = $date;                 $diff = getWorkdays($eingriffDatum, $histoDatum);                 $this->_values['biopsate']['count']++;                 $this->_values['biopsate']['val']['alle_biopsate']++;                 if ($diff >= 0 && $diff <= 5) {                    $this->_values['biopsate']['val']['kl5']++;                    $this->_values['biopsate']['min']['kl5']     = $this->_insert('min', $this->_values['biopsate']['min']['kl5'], $diff);                    $this->_values['biopsate']['max']['kl5']     = $this->_insert('max', $this->_values['biopsate']['max']['kl5'], $diff);                    $this->_values['biopsate']['range']['kl5']   = $this->_insert('range', $this->_values['biopsate']['max']['kl5'], $this->_values['biopsate']['min']['kl5']);                 } elseif($diff > 5) {                    $this->_values['biopsate']['val']['gr5']++;                    $this->_values['biopsate']['min']['gr5']     = $this->_insert('min', $this->_values['biopsate']['min']['gr5'], $diff);                    $this->_values['biopsate']['max']['gr5']     = $this->_insert('max', $this->_values['biopsate']['max']['gr5'], $diff);                    $this->_values['biopsate']['range']['gr5']   = $this->_insert('range', $this->_values['biopsate']['max']['gr5'], $this->_values['biopsate']['min']['gr5']);                 }              }           }        }        //Biopsie Untersuchungen        $biopsieUntersuchungen        = strlen($dataset['biopsie_untersuchungen']) > 0   ? explode(',', $dataset['biopsie_untersuchungen']) : array();        $pbiopsieUntersuchungHistos   = strlen($dataset['p_biopsie_u_histos']) > 0       ? explode(',', $dataset['p_biopsie_u_histos'])     : array();        if (count($biopsieUntersuchungen) > 0 && count($pbiopsieUntersuchungHistos) > 0) {           $bu = array();           foreach ($biopsieUntersuchungen as $b) {              $ident = explode('|', $b);              $bu[reset($ident)] = end($ident);           }           foreach ($pbiopsieUntersuchungHistos as $histo) {              $ident   = explode('|', $histo);              $date    = reset($ident);              $uId     = end($ident);              if (array_key_exists($uId, $bu) === true) {                 $untersuchungDatum = $bu[$uId];                 $histoDatum = $date;                 $diff = getWorkdays($untersuchungDatum, $histoDatum);                 $this->_values['biopsate']['count']++;                 $this->_values['biopsate']['val']['alle_biopsate']++;                 if ($diff >= 0 && $diff <= 5) {                    $this->_values['biopsate']['val']['kl5']++;                    $this->_values['biopsate']['min']['kl5']     = $this->_insert('min', $this->_values['biopsate']['min']['kl5'], $diff);                    $this->_values['biopsate']['max']['kl5']     = $this->_insert('max', $this->_values['biopsate']['max']['kl5'], $diff);                    $this->_values['biopsate']['range']['kl5']   = $this->_insert('range', $this->_values['biopsate']['max']['kl5'], $this->_values['biopsate']['min']['kl5']);                 } elseif($diff >5) {                    $this->_values['biopsate']['val']['gr5']++;                    $this->_values['biopsate']['min']['gr5']     = $this->_insert('min', $this->_values['biopsate']['min']['gr5'], $diff);                    $this->_values['biopsate']['max']['gr5']     = $this->_insert('max', $this->_values['biopsate']['max']['gr5'], $diff);                    $this->_values['biopsate']['range']['gr5']   = $this->_insert('range', $this->_values['biopsate']['max']['gr5'], $this->_values['biopsate']['min']['gr5']);                 }              }           }        }        //Praeparat Eingriff        $praeparatEingriffe        = strlen($dataset['praeparat_eingriffe']) > 0  ? explode(',', $dataset['praeparat_eingriffe'])   : array();        $ppraeparatEingriffHistos  = strlen($dataset['p_praeparat_e_histos']) > 0 ? explode(',', $dataset['p_praeparat_e_histos'])  : array();        if (count($praeparatEingriffe) > 0 && count($ppraeparatEingriffHistos) > 0) {           $pe = array();           foreach ($praeparatEingriffe as $b) {              $ident = explode('|', $b);              $pe[reset($ident)] = end($ident);           }           foreach ($ppraeparatEingriffHistos as $histo) {              $ident   = explode('|', $histo);              $date    = reset($ident);              $uId     = end($ident);              if (array_key_exists($uId, $pe) === true) {                 $eingriffDatum = $pe[$uId];                 $histoDatum = $date;                 $diff = getWorkdays($eingriffDatum, $histoDatum);                 $this->_values['praeparate']['count']++;                 $this->_values['praeparate']['val']['alle_praeparate']++;                 if ($diff >= 0 && $diff <= 7) {                    $this->_values['praeparate']['val']['kl7']++;                    $this->_values['praeparate']['min']['kl7']     = $this->_insert('min', $this->_values['praeparate']['min']['kl7'], $diff);                    $this->_values['praeparate']['max']['kl7']     = $this->_insert('max', $this->_values['praeparate']['max']['kl7'], $diff);                    $this->_values['praeparate']['range']['kl7']   = $this->_insert('range', $this->_values['praeparate']['max']['kl7'], $this->_values['praeparate']['min']['kl7']);                 } elseif($diff > 7) {                    $this->_values['praeparate']['val']['gr7']++;                    $this->_values['praeparate']['min']['gr7']     = $this->_insert('min', $this->_values['praeparate']['min']['gr7'], $diff);                    $this->_values['praeparate']['max']['gr7']     = $this->_insert('max', $this->_values['praeparate']['max']['gr7'], $diff);                    $this->_values['praeparate']['range']['gr7']   = $this->_insert('range', $this->_values['praeparate']['max']['gr7'], $this->_values['praeparate']['min']['gr7']);                 }              }           }        }         //Angabe pT, pN bei invasivem Karzinom         if (substr($dataset['morphologie'], -2) == '/3') {            $this->_values['ptpn_invasiv']['count']++;            $this->_values['ptpn_invasiv']['val']['alle']++;            $this->_values['ptpn_invasiv']['val']['ptpn'] += (int) (strlen($dataset['pt']) > 0 && strlen($dataset['pn']) > 0);         }         //Radikale Prostatektomie         if (strlen($dataset['radikale_prostatektomie']) > 0 && $dataset['radikale_prostatektomie'] == '1') {            $this->_values['resektion']['count']++;            $this->_values['resektion']['val']['alle']++;            $this->_values['resektion']['val']['r0']  += (int) ($dataset['r_lokal'] == '0');            $this->_values['resektion']['val']['r1']  += (int) ($dataset['r_lokal'] == '1');            $this->_values['resektion']['val']['abstand']  += (int) (strlen($dataset['resektionsrand']) > 0);         }      } //foreach end      $operateure      = $this->loadRessource('prostatektomieOperateure');      $operateurData   = array();      foreach ($operateure as $dataset) {         if (strlen($dataset['operateure']) > 0) {            $art            = explode('|', $dataset['operateure']);            $eingriffId     = $dataset['eingriff_id'];            $op1            = $art[0];            $op2            = $art[1];            $operateure = array($op1, $op2);            //$x = 0 == 1.Operateur / $x = 1 == Assistenz            foreach ($operateure as $x => $operateur) {               if (strlen($operateur) > 0) {                 if (array_key_exists($operateur, $operateurData) === false) {                    $operateurData[$operateur] = $this->_buildOpArray();                 }                 $operateurData[$operateur]['val'][$eingriffId] = 1;                 if ($x == 0) {                    $operateurData[$operateur]['op_operateur'][$eingriffId] = 1;                 } else {                    $operateurData[$operateur]['op_assi'][$eingriffId] = 1;                 }               }            }         }      }      //Zuweisung Operateure      foreach ($operateurData as $arzt => $op) {         $this->_values['operateure']['val'][$arzt]               = count($op['val']);         $this->_values['operateure']['op_operateur'][]           = count($op['op_operateur']);         $this->_values['operateure']['op_assi'][]                = count($op['op_assi']);         $this->_values['operateure']['op_assi_anteil'][]         = number_format((count($op['op_assi']) * 100 / count($op['val'])), 1, ',', '') . '%';      }      //Chemotherapien      $chemotherapien = $this->loadRessource('chemoImmuntherapien');      foreach ($chemotherapien AS $chemoTherapy) {         $org = $chemoTherapy['org_id'];         $count = $chemoTherapy['count'];         $this->_values['chemo_p_indikation']['val'][$org] = $count;      }      require_once 'reports/pdf/p/p03/p1.php';      require_once 'reports/pdf/p/p03/p2.php';   }   private function _insert($type, $src, $value, $default = '-')   {      $val = $src !== $default ? $src : $default;      switch ($type) {         case 'range':            if (is_int($src) == true && is_int($value) == true) {               $val = $src - $value;            }            break;         case 'max':         case 'min':            if (strlen($value) > 0) {               $value   = (int) $value;               $src     = $src !== $default ? $src : (                  $type == 'min' ? $value : 0               );               eval('$compare = $type == "max" ? ($value >= $src) : ($value <= $src);');               if ($compare == true) {                  $val = $value;               }            } else {               $val = $src;            }            break;      }      return $val;   }   private function _buildOpArray()   {      return array(         'val'             => array(),         'op_operateur'    => array(),         'op_assi'         => array(),         'op_assi_anteil'  => array()      );   }}?>